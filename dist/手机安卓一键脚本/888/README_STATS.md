# 请求统计功能说明

## 新增功能概述

本项目新增了**请求统计功能**，可以实时显示上游API请求的各种状态，帮助用户了解代理服务的运行情况。

## 统计指标

### 1. 基础统计
- **总请求数**: 所有发送到上游API的请求总数
- **成功请求**: 成功获取有效响应的请求数
- **失败请求**: 各种原因导致失败的请求总数
- **截断请求**: 响应内容长度小于配置的最小长度的请求

### 2. 详细错误分类
- **限流请求**: 收到429 Too Many Requests响应的请求
- **超时请求**: 请求超时的数量
- **404错误**: 请求URL不存在的错误
- **其他失败**: 其他类型的失败请求

### 3. 成功率指标
- **成功率**: 成功请求占总请求的百分比
- **失败率**: 失败请求占总请求的百分比
- **截断率**: 截断请求占总请求的百分比

## 使用方法

### 1. 查看统计信息
- 打开Web管理界面（默认 http://localhost:5000）
- 点击"状态"标签页
- 查看"请求统计"面板

### 2. 实时更新
- 统计信息每5秒自动刷新
- 无需手动刷新页面

### 3. 重置统计
- 点击"重置统计"按钮可以清零所有统计数据
- 重置后立即生效

## API接口

### 获取统计信息
```
GET /api/stats
```

返回示例：
```json
{
  "stats": {
    "total_requests": 100,
    "successful_requests": 85,
    "failed_requests": 15,
    "truncated_requests": 5,
    "rate_limited_requests": 8,
    "not_found_requests": 0,
    "timeout_requests": 2,
    "last_updated": 1692000000.0
  },
  "success_rate": 85.0,
  "failure_rate": 15.0,
  "truncation_rate": 5.0
}
```

### 重置统计
```
POST /api/stats/reset
```

## 技术实现

### 后端实现
- 使用全局字典存储统计信息
- 在`send_single_request`函数中记录各种状态
- 提供RESTful API接口获取和重置统计

### 前端实现
- 使用JavaScript定时器每5秒自动刷新
- 直观的进度条显示成功率
- 响应式设计，适配移动端

## 使用场景

1. **监控服务质量**: 实时了解代理服务的运行状态
2. **排查问题**: 快速识别限流、超时等问题
3. **优化配置**: 根据统计数据调整超时时间、最小响应长度等参数
4. **容量规划**: 了解API使用频率，合理配置API密钥数量

## 注意事项

- 统计数据存储在内存中，重启服务会丢失
- 建议定期记录重要统计数据
- 在Termux环境中，确保网络权限已开启